{% extends 'site_admin/admin_base.html' %}

{% load eval includes pagination permissions %}

{% block main_table_content %}
    
    <script type="text/javascript">
        
        function updateTagCount() {
            var count = $('#multisearch_tags').data('multisearch').getNumSelectedOptions();
            $('#tag-count').html('(' + count + ')');
        }
        
        function CreateOverShadow(elem, html) {
            elem = $(elem);
            if (elem.data('overShadow')) {
                // Already has a shadow, update the html
                elem.data('overShadow').updateHtml(html);
            } else {
                // Create a new shadow
                new OverShadow(elem, html);
            }
        }
        
        // Creates a shadow layer over the top of elem, matching the size & position.
        // Uses 'html' as the content of the layer.
        function OverShadow(elem, html) {
            this.elem = $(elem);
            elem.data('overShadow', this);
            
            var pos = getElemPos(elem);
            this.shadowElem = $('<div class="over-shadow"></div>').appendTo('body');
            this.shadowElem.css('left', pos.x + 'px');
            this.shadowElem.css('top', pos.y + 'px');
            this.shadowElem.css('width', elem.attr('offsetWidth') + 'px');
            this.shadowElem.css('height', elem.attr('offsetHeight') + 'px');
            
            this.contentElem = $('<div class="over-shadow-content"></div>').appendTo('body');
            this.contentElem.css('left', pos.x + 'px');
            this.contentElem.css('top', pos.y + 'px');
            this.contentElem.css('width', elem.attr('offsetWidth') + 'px');
            this.contentElem.css('height', elem.attr('offsetHeight') + 'px');
            this.contentElem.html(html);
        }
        
        OverShadow.prototype.updateHtml = function(html) {
            this.contentElem.html(html);
        }
        
        OverShadow.prototype.hide = function() {
            this.shadowElem.remove();
            this.shadowElem = null;
            this.contentElem.remove();
            this.contentElem = null;
            this.elem.data('overShadow', null);
            this.elem = null;
        }
        
        //////////
        
        function refreshTagsTable() {
            //log('refreshTagsTable()');
            CreateOverShadow($('#tags-table-content'), '<div class="tags-table-loading">Loading...</div>');
            $('#tags-table-content').load("{% url admin_manage_society_tags_table society.id tag_sort tag_page %}", refreshTagsTable2);
        }
        
        function refreshTagsTable2() {
            //log('refreshTagsTable2()');
            if ($('#tags-table-content').length && $('#tags-table-content').data('overShadow'))
                $('#tags-table-content').data('overShadow').hide();
        }
        
        window.notify = function(action, data) {
            if (action == 'created_tag') {
                // Just created a tag, add it to the field
                var multisearch = $('#multisearch_tags').data('multisearch');
                
                // Add the newly created tag to the list of options
                multisearch.addSelectedOption({
                    name: data.tag.name,
                    name_link: data.tag.name_link,
                    value: data.tag.value,
                    tag_name: data.tag.tag_name,
                    sector_names: data.tag.sector_names,
                    num_societies: data.tag.num_societies.toString(),
                    num_related_tags: data.tag.num_related_tags.toString(),
                    num_filters: data.tag.num_filters.toString(),
                    num_resources: data.tag.num_resources.toString()
                });
                
                // Trigger a refresh of the popup
                multisearch.updatePopup();
                
                // Update the tags table
                refreshTagsTable();
                
            } else if (action == 'added_multisearch_option') {
                // Ignore this event
                //log('event added_multisearch_option ignored');
                
            } else if (action == 'preloaded_multisearch_option') {
                // Ignore this event
                //log('event preloaded_multisearch_option ignored');
                
            } else if (action == 'removed_multisearch_option') {
                // Ignore this event
                //log('event removed_multisearch_option ignored');
                
            } else if (action == 'multisearch_create_new_tag') {
                Lightbox.show('{% url admin_create_tag %}?default_tag_name=' + escape(data.tag_name) + '&society_id=' + {{ society.id }}, {
                    closeOnClickOutside: false
                });
                
                
            } else {
                alert('notify(): unknown action "' + action + '"');
            }
        
        }
        
        
        function attachMultisearch() {
            // Find the tag multisearch
            var multisearch_tags = $('#multisearch_tags').data('multisearch');
            
            // Preloading might already be done, update the tag count now
            updateTagCount();
            
            if (multisearch_tags != undefined)  {
                // Multisearch is ready, attach events
                
                multisearch_tags.subscribe('added_option', function(multisearch, event, data) {
                    //log('event added_option');
                    $.post('{% url ajax_update_society %}', {
                        action: 'add_tag',
                        society_id: {{ society.id }},
                        tag_id: data.option.value
                    });
                    updateTagCount()
                    
                    // Update the tags table
                    refreshTagsTable();
                });
                
                // NOTE: By the time this gets fired, preloading will probably already be done.
                multisearch_tags.subscribe('preloaded_option', function(multisearch, event, data) {
                    updateTagCount();
                });
                
                multisearch_tags.subscribe('removed_option', function(multisearch, event, data) {
                    //log('event removed_option');
                    $.post('{% url ajax_update_society %}', {
                        action: 'remove_tag',
                        society_id: {{ society.id }},
                        tag_id: data.option.value
                    });
                    updateTagCount()
                    
                    // Update the tags table
                    refreshTagsTable();
                });
                
            } else {
                // Multisearch is not ready yet, wait and try again
                setTimeout(attachMultisearch, 50);
            }
        }
        
        $(function() {
            attachMultisearch();
        });



    </script>

    {% comment %}
    {% ifpermission "user_can_edit_society" society %}
        <a href="{% url admin_edit_society society.id %}?return_url={{ current_url|urlencode }}" class="edit">Edit Society</a>
    {% endifpermission %}
    {% endcomment %}
    <h1>{{ society.name }} ({{ society.abbreviation }}) Society</h1>
    
    <table class="full-grid manage-grid">
        {% comment %}
        <tr>
            <th>
                Name:
            </th>
            <td width="80%">
                {{ society.name }}
            </td>
        </tr>
        <tr>
            <th>
                Abbreviation:
            </th>
            <td>
                {{ society.abbreviation }}
            </td>
        </tr>
        <tr>
            <th>
                Url
            </th>
            <td>
                {{ society.url }}
            </td>
        </tr>
        <tr>
            <th>
                Users
            </th>
            <td>
                {% for user in society.users.all %}
                    <a href="{% url admin_view_user user.id %}">{{ user.username }}</a>, 
                {% endfor %}
            </td>
        </tr>
        {% endcomment %}
        <tr>
            <td colspan="2" style="border: none;">
                
                {# <form action="{% url admin_manage_society society.id %}" method="post"> #}
                    
                    <div id="society-resource-tabs" class="nootabs {useCookies:false, useHash:true}">
                        <ul class="nootabs-menus">
                            <li><a href="">Manage this Society's Resources ({{ num_resources }})</a></li>
                            <li><a href="">Manage this Society's Tags <span id="tag-count"></span></a></li>
                            {% if DEBUG_ENABLE_MANAGE_SOCIETY_HELP_TAB %}
                                <li><a href="">Help</a></li>
                            {% endif %}
                        </ul>
                        
                        <!-- Resources Tab -->
                        <div id="resources-tab" class="nootabs-tab">
                            <ul class="pages">
                                <li class="paginationTitle">Pages:</li>
                                {% pages resource_page num_resource_pages resource_page_url %}
                            </ul>
                            
                            <table class="resources">
                                <tr>
                                    {% comment %}
                                        <th>
                                        </th>
                                    {% endcomment %}
                                    <th>
                                        Resource Name <span class="help_icon flyover" title="Name of the Product or Service. Click resource to edit.">[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=name_ascending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "name_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=name_descending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "name_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                        
                                    </th>
                                    <th>
                                        ID <span class="help_icon flyover" title="IEEE unique identifier.">[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=ieee_id_ascending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "ieee_id_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=ieee_id_descending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "ieee_id_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                    </th>
                                    <th>
                                        Resource Type <span class="help_icon flyover" title="Publication, Conference, or Standard.">[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=resource_type_ascending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "resource_type_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=resource_type_descending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "resource_type_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                    </th>
                                    <th>
                                        URL <span class="help_icon flyover" title="Web link for the Resource.">[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=url_ascending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "url_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=url_descending" class="live-url {hashOnly:true}">
                                            {% ifequal resource_sort "url_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                    </th>
                                    <th>
                                        Tags <span class="help_icon flyover" title="List of key words or phrases for related concepts and technology areas.">[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=num_tags_ascending" class="live-num_tags {hashOnly:true}">
                                            {% ifequal resource_sort "num_tags_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=num_tags_descending" class="live-num_tags {hashOnly:true}">
                                            {% ifequal resource_sort "num_tags_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                    </th>
                                    <th>
                                        Societies <span class="help_icon flyover" title="IEEE organizations that sponsor this resource.">[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=num_societies_ascending" class="live-num_societies {hashOnly:true}">
                                            {% ifequal resource_sort "num_societies_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=num_societies_descending" class="live-num_societies {hashOnly:true}">
                                            {% ifequal resource_sort "num_societies_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                    </th>
                                    <th>
                                        Priority <span class="help_icon flyover" title='If "yes", this resource should be as complete as possible. Tags, Description, and URL.'>[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=priority_ascending" class="live-priority {hashOnly:true}">
                                            {% ifequal resource_sort "priority_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=priority_descending" class="live-priority {hashOnly:true}">
                                            {% ifequal resource_sort "priority_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                    </th>
                                    <th>
                                        Description <span class="help_icon flyover" title="Short description of the Resource. 1-3 short sentences recommended.">[?]</span>
                                        
                                        <div class="table-sort">
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=description_ascending" class="live-description {hashOnly:true}">
                                            {% ifequal resource_sort "description_ascending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_up_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        <a href="{% url admin_manage_society society.id %}?resource_sort=description_descending" class="live-description {hashOnly:true}">
                                            {% ifequal resource_sort "description_descending" %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_active.png" />
                                            {% else %}
                                                <img src="{{ MEDIA_URL }}images/sort_arrow_down_inactive.png" />
                                            {% endifequal %}
                                        </a>
                                        </div>
                                    </th>
                                </tr>
                                {% for resource in resources %}
                                    
                                    {% if resource.priority_to_tag %}
                                        <tr class="priority-to-tag-resource">
                                    {% else %}
                                        <tr>
                                    {% endif %}
                                    
                                        {% comment %}
                                            <td class="count">
                                                {{ resource.count }}
                                            </td>
                                        {% endcomment %}
                                        <td class="first-item">
                                            <a href="{% url admin_edit_resource resource.id %}?return_url={{ current_url|urlencode }}&amp;society_id={{ society.id }}">{{ resource.name }}</a>
                                        </td>
                                        <td>
                                            {{ resource.ieee_id }}
                                        </td>
                                        <td>
                                            {{ resource.resource_type.name|capfirst }}
                                            {% ifequal resource.resource_type.name "standard" %}
                                                <br/>({{ resource.standard_status }})
                                            {% endifequal %}
                                        </td>
                                        <td>
                                            {% if resource.url %}<a href="{{ resource.url }}" target="_blank"><span class="flyover {position:'bottom'}" title="{{ resource.url }}"><img src="{{ MEDIA_URL }}/images/popup.png"/></span></a>{% endif %}
                                        </td>
                                        <td>
                                            {% if resource.nodes.all %}{{ resource.nodes.all.count }}{% endif %}
                                        </td>
                                        <td>
                                            {% if resource.societies.all %}
                                                {{ resource.society_abbreviations|join:", " }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if resource.priority_to_tag %}
                                                {{ resource.priority_to_tag|yesno|capfirst }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if resource.description %}
                                                <span class="flyover { position:'left', customClass:'resource-description'} " title="{{ resource.description }}">
                                                    <img src="{{ MEDIA_URL }}images/notes_icon.jpg" />
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                            <ul class="pages">
                                <li class="paginationTitle">Pages:</li>
                                {% pages resource_page num_resource_pages resource_page_url %}
                            </ul>
                            <div style="margin-top: 1em;">
                                <a href="{% url missing_resource society.id %}" class="lightbox">Don't see the resource you need? Request it be added.</a>
                            </div>
                        </div>
                        
                        <!-- Tags Tab -->
                        <div id="tags-tab" class="nootabs-tab">
                            <input type="button" id="create-tag-float" onclick="location.href='{% url admin_create_tag %}?society_id={{ society.id }}&amp;return_url={{ tags_tab_url|urlencode }}';" value="Create New Tag" />
                            {% eval form['tags'] %}
                            
                            <div id="tags-table-content">
                                {% manage_society_tags_table %}
                                
                            </div>
                            <br style="clear:both;"/>
                        </div>
                        
                        {% if DEBUG_ENABLE_MANAGE_SOCIETY_HELP_TAB %}
                            <!-- Help Tab -->
                            <div id="help-tab" class="nootabs-tab">
                                <h2>Help</h2>
                                
                                <p>
                                    Need a quick orientation to the Administrative Interface for Technology Navigator? Watch this short video.
                                </p>
                                
                                <h3>Video Overview of Administrative Interface</h3>
                                
                                <object id='stU09QREBIR11eQFtbUlNYUlJV' width='425' height='344' type='application/x-shockwave-flash' data='http://www.screentoaster.com/swf/STPlayer.swf' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,115,0'>
                                    <param name='movie' value='http://www.screentoaster.com/swf/STPlayer.swf'/>
                                    <param name='allowFullScreen' value='true'/>
                                    <param name='allowScriptAccess' value='always'/>
                                    <param name='flashvars' value='video=stU09QREBIR11eQFtbUlNYUlJV'/>
                                    <param name='wmode' value='opaque'/>
                                </object>
                                <br/>
                                <br/>
                                
                                <h3>Managing Resources in the Administrative Interface</h3>
                                
                                <object id='stU09QREBIR11eQV9aWV9cUV5U' width='425' height='344' type='application/x-shockwave-flash' data='http://www.screentoaster.com/swf/STPlayer.swf'  codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,115,0'>
                                    <param name='movie' value='http://www.screentoaster.com/swf/STPlayer.swf'/>
                                    <param name='allowFullScreen' value='true'/>
                                    <param name='allowScriptAccess' value='always'/>
                                    <param name='flashvars' value='video=stU09QREBIR11eQV9aWV9cUV5U'/>
                                    <param name='wmode' value='opaque'/>
                                </object>
                                
                                <p>
                                    If you'd like more context, or the video isn't working for you, please read through our Overview and Walkthrough documents.
                                </p>
                                
                                <p>
                                    <a href="{{ MEDIA_URL }}pdf/Tech%20Nav%20Administrative%20Overview.pdf" target="_blank" class="help-doc">
                                        <img src="{{ MEDIA_URL }}images/pdf_icon_small.png" style="vertical-align:middle;"/>
                                        Overview document (PDF)
                                    </a>
                                    <a href="{{ MEDIA_URL }}pdf/Administrative%20Interface%20Walkthrough.pdf" target="_blank" class="help-doc">
                                        <img src="{{ MEDIA_URL }}images/pdf_icon_small.png" style="vertical-align:middle;"/>
                                        Walkthrough document (PDF)
                                    </a>
                                </p>
                                
                                <p class="last-paragraph">
                                    Questions still not answered? Email us at <a href="mailto:technav@ieee.org">technav@ieee.org</a>.
                                </p>
                                
                                <br/>
                                
                                <h2>Survey</h2>
                                <p>
                                    Click here to <a href="#" onclick="window.open('http://rneville.wufoo.com/forms/q7x3z9/',  null, 'height=970, width=680, toolbar=0, location=0, status=1, scrollbars=1'); return false" title="IEEE Technology Navigator Survey">fill out a survey</a> about the IEEE Technology Navigator.
                                </p>
                                {% comment %}
                                    <!-- Embedded version of the survey -->
                                    <script type="text/javascript">var host = (("https:" == document.location.protocol) ? "https://secure." : "http://");document.write(unescape("%3Cscript src='" + host + "wufoo.com/scripts/embed/form.js' type='text/javascript'%3E%3C/script%3E"));</script>
                                    <script type="text/javascript">
                                    var q7x3z9 = new WufooForm();
                                    q7x3z9.initialize({
                                    'userName':'rneville',
                                    'formHash':'q7x3z9',
                                    'autoResize':true,
                                    'height':'970'});
                                    q7x3z9.display();
                                    </script>
                                {% endcomment %}
                                
                            </div>
                        {% endif %}
                        
                    </div>
                    
                    {% comment %}
                    <input type="submit" value="Save" class="button" />
                    {% endcomment %}
                    
                {# </form> #}
                
                
                <div class="feedback-bar">
                    Comments, Suggestions? <a href="{% url feedback %}" class="lightbox">Send Feedback</a> or <a href="#" onclick="window.open('http://rneville.wufoo.com/forms/q7x3z9/',  null, 'height=970, width=680, toolbar=0, location=0, status=1, scrollbars=1'); return false" title="IEEE Technology Navigator Survey">Complete a Survey</a>
                </div>
                
            </td>
        </tr>
        
    </table>
    
{% endblock %}
