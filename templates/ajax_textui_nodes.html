{% load filters %}

{% if search_for %}
    {% if search_for_too_short %}
        <h3>The filter string <b>{{ search_for }}</b> is too short. Please enter more characters above OR <a href="javascript:void(0)" onclick="$('#textui-tags-search-clear').click()">clear the filter now</a>.</h3>
    {% else %}
        <h3>
        {# If the view returned results summary, use it. If not (happens when "All Sectors" or "All Societies" are chosen), construct one. #}
        {% if search_page_title %}
			{{ search_page_title.num }} results for <b>{{ search_page_title.search_for }}</b> {{search_page_title.node_desc }}
        {% else %}
            {{ child_nodes|length }} result{{ child_nodes|length|pluralize }} for "{{ search_for }}"{% ifnotequal child_nodes|length 0 %}:{% else %}.{% endifnotequal %}
        {% endif %}
        
        {# Extra message for when there are zero results #}
        {% ifequal child_nodes|length 0 %}
            &nbsp;You might try entering fewer characters above or <a href="javascript:void(0)" onclick="$('#textui-tags-search-clear').click()">clearing the filter phrase now</a>.
        {% endifequal %}
        </h3>
    {% endif %}
{% endif %}

{% spaceless %}
{% for tag in child_nodes %}
    <div id="tag-{{ tag.id }}" class="node {{ tag.node_type__name }} flyover">
        {% ifequal tag.node_type__name 'tag' %}
            <a href="javascript:Tags.selectTag({{ tag.id }});" class="{{ tag.level }}">{{ tag.name|truncatechars:30 }}</a>
        {% else %}
            {% ifequal tag.node_type__name 'tag_cluster' %}
                <a href="javascript:Tags.selectCluster({{ tag.id }}, {{ sector_id|default_if_none:"null" }});" class="{{ tag.level }}">
                    <img src="/media/images/icon_cluster_sm.png" />
                    {{ tag.name|truncatechars:30 }}
                </a> 
            {% endifequal %}
        {% endifequal %}
    
        {% comment %}
        #if (!simplified) {
        #    // NOTE: Only show the separate color blocks if we're not using the simplified mode
        #    str += "      <td>";
        #    str += "        <div class=\"node-block-container\">";
        #    str += "          <div class=\"block-top " + tag.sectorLevel + "\">&nbsp;</div>";
        #    str += "          <div class=\"block-bottom " + tag.relatedTagLevel + "\">&nbsp;</div>";
        #    str += "        </div>";
        #    str += "      </td>";
        #}
        {% endcomment %}
    </div>
    
    {% comment %}
    #} else if (type == 'tag_cluster') {
    #    // Show the cluster flyover
    #    div.hover(
    #        function() {
    #            Flyover.show(
    #                this,
    #                {
    #                    url: '/ajax/tooltip/'+$(this).data('tagId')+'?parent_id='+$(this).data('sectorId')+'&society_id='+$(this).data('societyId'),
    #                    position: 'auto',
    #                    hideDelay: 100
    #                }
    #            );
    #        },
    #        function() {
    #            Flyover.onMouseOut();
    #        }
    #    );
    #}
    {% endcomment %}

{% endfor %}
{% endspaceless %}
<script>
    $(function() {
        // Calling special function to avoid code bloat due to duplication. The string "tagid" in the url will be replaced with the
        // actual id.
        attachTextUiFlyovers('#tags', {url: '/ajax/tooltip/tagid?parent_id={{ parent_id|default:"null" }}&society_id={{ society_id|default:"null" }}&search_for={{ search_for|urlencode }}', position: 'auto', customClass: 'textui-node', hideDelay: 400, positionCursor: false, closeButton: true });
    });
</script>


{% comment %}
#// Got a cluster
#var sectorLink = $('<a href="javascript:Tags.selectSector(' + data.tag.sector.id + ');" class="back-link"></a>').appendTo(tagWindow);
#sectorLink.html('<img src="' + MEDIA_URL + '/images/arrow2-up-small.png" /> Up to the "' + htmlentities(data.tag.sector.label) + '" sector');
#$('<br/>').appendTo(tagWindow);
#// Cluster title
#var title = $('<h2>' + htmlentities(data.tag.label) + ' cluster</h2>').appendTo(tagWindow);
{% endcomment %}
